<%- include("../shared/header"); %>


    <div class="app-page-title">

        <div class="page-title-wrapper">

            <div class="page-title-heading">

                <!-- <div class="page-title-icon">

                    <i class=" fas fa-sort-amount-up icon-gradient bg-mean-fruit">

                    </i>

                </div> -->

                <div>
                    <b> DISTRIBUTOR KYC </b>

                </div>

            </div>



        </div>

    </div>



    <div class="row">

        <div class="col-md-12 col-lg-12 mx-auto">

            <div class="mb-3 ">

                <div class="card">

                    <div class="card-header-tab card-header-tab-animation card-header">

                        <div class="row">

                            <div class=" col-lg-8 col-md-8  col-12">

                                <h5><b>SELECT REPORT TYPE</b></h5>

                            </div>

                            <div class="col-lg-4 col-lg-4 col-12 text-right">

                                <button id="btnExport" class="btn  btn-outline-alternate custom-button  mr-3"><i
                                        class="metismenu-icon fas fa-arrow-alt-circle-down mr-2"></i>Download</button>

                                <button class="btn-shadow  btn btn-primary custom-btn  btn-lg" data-toggle="collapse"
                                    data-target="#demo"><i class='fas fa-filter mr-2'></i>Filter</button>



                            </div>

                            <div class="mt-3 px-xl-2 col-12">
                                <div class="dis-grid">

                                    <a class="mt-2" href="./kyc">

                                        <img src="./images/off.png" alt="">
                                        DSR Kyc

                                    </a>

                                    <a class="mt-2" href="./edit-kyc-data">

                                        <img src="./images/off.png" alt="">

                                        DSR EDIT KYC

                                    </a>
                                    <a class="mt-2" href="./retailer">
                                        <img src="./images/off.png" alt="">
                                        RETAILER KYC
                                    </a>
                                    <!-- <a class="mt-2" href="./retailer-edit-kyc">
                                        <img src="./images/off.png" alt="">
                                        RETAILER EDIT KYC
                                    </a> -->
                                    <a class="mt-2" href="./distributor">
                                        <img src="./images/on.png" alt="">
                                        DISTRIBUTOR KYC
                                    </a>
                                    <a class="mt-2" href="./dsr_attendance">
                                        <img src="./images/off.png" alt="">
                                        DSR ATTENDANCE
                                    </a>

                                    <a class="mt-2" href="./payout">
                                        <img src="./images/off.png" alt="">
                                        DSR PAYOUT
                                    </a>
                                    <a class="mt-2" href="./kyc-history">
                                        <img src="./images/off.png" alt="">
                                        DSR KYC History</a>
                                    <a class="mt-2" href="./retailer-history">
                                        <img src="./images/off.png" alt="">
                                        RETAILER KYC History
                                    </a>

                                    <a class="mt-2" href="./master-data">

                                        <img src="./images/off.png" alt="">

                                        MASTER DATA

                                    </a>

                                    <a class="mt-2" href="./kyc-status">

                                        <img src="./images/off.png" alt="">

                                        KYC STATUS

                                    </a>

                                    <!-- <a class="mt-2" href="./awsm-updation">

                                        <img src="./images/off.png" alt="">

                                        AWSM UPDATION

                                    </a> -->

                                </div>

                            </div>

                        </div>



                    </div>

                    <div class="card-body">

                        <div id="demo" class="collapse">

                            <form action="./distributor">

                                <div class="row">

                                    <div class="col-3">
                                        <label for="Mobile" class="mr-sm-2"> Mobile Number</label>
                                        <input type="tel" maxlength="10" class="form-control" id="MobileNo"
                                            placeholder="Mobile" name="MobileNo" value="<%=QueryData.MobileNo %>">
                                    </div>
                                    <div class="col-3">
                                        <label for="Mobile" class="mr-sm-2">Enter Email id</label>
                                        <input type="email" class="form-control" id="Email" placeholder="Enter Email id"
                                            name="Email" value="<%=QueryData.Email %>">
                                    </div>

                                    <div class="col-3">

                                        <label for="FROM" class="mr-sm-2">FROM</label>

                                        <input type="date" class="form-control" id="fromDate" placeholder="fromDate"
                                            name="fromDate" value="<%=QueryData.fromDate %>">
                                    </div>

                                    <div class="col-3">

                                        <label for="TO" class="mr-sm-2">TO</label>

                                        <input type="date" class="form-control" id="toDate" placeholder="toDate"
                                            name="toDate" value="<%=QueryData.toDate %>">
                                    </div>
                                </div>
                                <div class="text-right mb-3">
                                    <button type="reset"
                                        class="btn-shadow  btn btn-primary custom-btn  btn-lg mt-3">Reset</button>
                                    <button type="submit"
                                        class="btn-shadow  btn btn-primary custom-btn  btn-lg mt-3">Apply</button>
                                </div>
                            </form>
                        </div>
                        <table id="example" class="table mt-2 table-striped table-bordered table-responsive"
                            cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th class="tabel-width"> Mobile Number</th>
                                    <th class="tabel-width"> Email id</th>
                                    <th class="tabel-width">name</th>
                                    <th class="tabel-width">distributor code</th>
                                    <th class="tabel-width">status</th>
                                </tr>
                            </thead>

                            <tbody>
                                <% userResult11.forEach((data)=> { %>
                                    <tr>
                                        <td>
                                            <%= data.MobileNo %>
                                        </td>
                                        <td>
                                            <%= data.Email %>
                                        </td>
                                        <td>
                                            <%= data.name %>

                                        </td>
                                        <td>
                                            <%= data.distributorcode %>

                                        </td>
                                        <td>
                                            <%= data.status %>

                                        </td>
                                    </tr>
                                    <% }) %>
                            </tbody>

                        </table>

                    </div>

                </div>

            </div>

        </div>

    </div>
    <div class="modal" id="imageModal" tabindex="-1" role="dialog">
        <div class="modal-dialog  modal-top " role="document">
            <div class="modal-content">
                <div class="modal-header">

                    <button type="button" class="close" onclick="modal_close()" data-bs-dismiss="modal"
                        fdprocessedid="n6zi5o">Ã—</button>
                </div>
                <div class="modal-body">
                    <img class="modal-content1" id="getImage-id" width="100px">
                </div>

            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var table = document.querySelector('#example');
            var dataTable = new DataTable(table, {

            });
        });
    </script>

    <script>

        function fnExcelReport(file, mobileno, email) {

            fetch(`/distributor/export?mobileno=${mobileno}&Email=${email}`)
                .then((res) => res.json())
                .then((data) => {

                    data.forEach((item) => {
                        // item.dob = formatDate(item.dob);
                        // item.created_on = formatDate(item.created_on);
                        item.insert_timestamp = formatDate(item.insert_timestamp);
                        // item.update_timestamp = formatDate(item.update_timestamp);
                        // item.bank_account_no = formatBankAccount(item.bank_account_no);
                    });

                    const csvContent = createCSV(data);

                    var element = document.createElement('a');
                    element.setAttribute('href', 'data:csv;charset=utf-8, ' + encodeURIComponent(csvContent));
                    element.setAttribute('download', file);

                    document.body.appendChild(element);

                    element.click();

                    document.body.removeChild(element);
                });
        }


        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatBankAccount(accountNumber) {
            return accountNumber.match(/.{1,4}/g).join(' ');
        }

        function createCSV(data) {

            const headers = [
                "Mobile.No.",
                "Email",
                "Name",
                "DistributorCode",
                "status"
            ]

            const flattenData = data.map(item => ({
                "Mobile.No.": item.MobileNo,
                "Email": item.Email,
                "Name": item.name,
                "DistributorCode": item.distributorcode,
                "status": item.status,
            }));
            const replacer = (key, value) => (value === null ? "" : value);
            const csvContent = [headers.join(","), ...flattenData.map(row => headers.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(","))].join("\r\n");
            return csvContent;

        }


        document.getElementById("btnExport").addEventListener("click", function () {
            var filename = "distributor.csv";
            var mobileno = document.getElementById("MobileNo").value;
            var email = document.getElementById("Email").value;
            fnExcelReport(filename, mobileno, email);
        }, false);

    </script>
    <%- include("../shared/footer"); %>
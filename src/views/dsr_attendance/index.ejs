<%- include("../shared/header"); %>

  <div class="app-page-title">
    <div class="page-title-wrapper">
      <div class="page-title-heading">
        <!-- <div class="page-title-icon">
                    <i class=" fas fa-sort-amount-up icon-gradient bg-mean-fruit">
                    </i>
                </div> -->
        <div>
          <b> DSR ATTENDANCE</b>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12 col-lg-12 mx-auto">
      <div class="mb-3">
        <div class="card">
          <div class="card-header-tab card-header-tab-animation card-header">
            <div class="row">
              <div class="col-lg-8 col-md-8 col-12">
                <h5><b>SELECT REPORT TYPE</b></h5>
              </div>
              <div class="col-lg-4 col-lg-4 col-12 text-right">
                <button id="btnExport" class="btn btn-outline-alternate custom-button mr-3">
                  <i class="metismenu-icon fas fa-arrow-alt-circle-down mr-2"></i>Download
                </button>
                <button class="btn-shadow btn btn-primary custom-btn btn-lg" data-toggle="collapse" data-target="#demo">
                  <i class="fas fa-filter mr-2"></i>Filter
                </button>
              </div>
              <div class="mt-3 px-xl-2 col-12">
                <div class="dis-grid">
                  <a class="mt-2" href="./kyc">
                    <img src="./images/off.png" alt="" />
                    DSR Kyc
                  </a>
                  <a class="mt-2" href="./edit-kyc-data">
                    <img src="./images/off.png" alt="" />
                    DSR EDIT KYC
                  </a>
                  <a class="mt-2" href="./retailer">
                    <img src="./images/off.png" alt="" />
                    RETAILER KYC
                  </a>
                  <!-- <a class="mt-2" href="./retailer-edit-kyc">
                    <img src="./images/off.png" alt="">
                    RETAILER EDIT KYC
                  </a> -->
                  <a class="mt-2" href="./distributor">
                    <img src="./images/off.png" alt="" />
                    DISTRIBUTOR KYC
                  </a>
                  <a class="mt-2" href="./dsr_attendance">
                    <img src="./images/on.png" alt="" />
                    DSR ATTENDANCE
                  </a>
                  <a class="mt-2" href="./payout">
                    <img src="./images/off.png" alt="" />
                    DSR PAYOUT
                  </a>
                  <a class="mt-2" href="./kyc-history">
                    <img src="./images/off.png" alt="" />
                    DSR KYC History</a>
                  <a class="mt-2" href="./retailer-history">
                    <img src="./images/off.png" alt="" />
                    RETAILER KYC History
                  </a>
                  <a class="mt-2" href="./master-data">
                    <img src="./images/off.png" alt="" />
                    MASTER DATA
                  </a>
                  <a class="mt-2" href="./kyc-status">
                    <img src="./images/off.png" alt="" />
                    KYC STATUS
                  </a>
                  <!-- <a class="mt-2" href="./awsm-updation">
                                        <img src="./images/off.png" alt="">
                                        AWSM UPDATION
                                    </a> -->
                </div>
              </div>
            </div>
          </div>
          <div class="table-responsive">
            <div class="card-body">
              <div id="demo" class="collapse">
                <form action="./dsr_attendance">
                  <div class="row">
                    <div class="col-3">
                      <label for="dsr_id" class="mr-sm-2">DSR ID</label>
                      <input type="text" class="form-control" id="dsr_id" placeholder="dsr_id" name="dsr_id"
                        value="<%=QueryData.dsr_id %>" />
                    </div>

                    <div class="col-3">
                      <label for="salesman_name" class="mr-sm-2">DSR NAME</label>
                      <input type="text" class="form-control" id="dsr_name" placeholder="dsr_name" name="dsr_name"
                        value="<%=QueryData.salesman_name %>" />
                    </div>
                    <div class="col-3">
                      <label for="FROM" class="mr-sm-2">FROM</label>

                      <input type="date" class="form-control" id="fromDate" placeholder="fromDate" name="fromDate"
                        value="<%=QueryData.fromDate %>" />
                    </div>
                    <div class="col-3">
                      <label for="TO" class="mr-sm-2">TO</label>

                      <input type="date" class="form-control" id="toDate" placeholder="toDate" name="toDate"
                        value="<%=QueryData.toDate %>" />
                    </div>
                  </div>

                  <div class="text-right mb-3">
                    <!-- <a href="./authentication"
                                            class="btn btn-outline-alternate  custom-button  reset-anchor mr-3 mt-3">Reset</a> -->
                    <button type="reset" class="btn-shadow btn btn-primary custom-btn btn-lg mt-3">
                      Reset
                    </button>
                    <button type="submit" class="btn-shadow btn btn-primary custom-btn btn-lg mt-3">
                      Apply
                    </button>
                  </div>
                </form>
              </div>


              <div class="table table-striped table-bordered table-responsive dataTable no-footer">
                <table id="example" class="table dataTables_wrapper table-bordered" cellspacing="0" width="100%">
                  <thead>
                    <tr>
                      <th class="tabel-width">DSR ID</th>
                      <th class="tabel-width">DSR Name</th>
                      <th class="tabel-width">DATE Time</th>
                      <th class="tabel-width">Attendance Status</th>
                      <th class="tabel-width">Tenure</th>
                    </tr>

                  </thead>
                  <tbody>
                    <% userResult11.forEach((data)=> { %>
                      <tr>
                        <td>
                          <%= data.dsr_id %>
                        </td>
                        <td>
                          <%= data.dsr_name %>
                        </td>
                        <td>
                          <%= data.date %>
                        </td>
                        <td>
                          <%= data.attendance_status %>
                        </td>
                        <td>
                          <%= data.tenure %>
                        </td>
                      </tr>
                      <% }) %>
                  </tbody>
                </table>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var table = document.querySelector('#example');
      var dataTable = new DataTable(table, {

      });
    });
  </script>

  <script>

    function fnExcelReport(file, dsr_id, dsr_name) {

      fetch(`/dsr_attendance/export?dsr_id=${dsr_id}&dsr_name=${dsr_name}`)
        .then((res) => res.json())
        .then((data) => {

          data.forEach((item) => {
            // item.dob = formatDate(item.dob);
            // item.created_on = formatDate(item.created_on);
            item.insert_timestamp = formatDate(item.insert_timestamp);
            // item.update_timestamp = formatDate(item.update_timestamp);
            // item.bank_account_no = formatBankAccount(item.bank_account_no);
          });

          const csvContent = createCSV(data);

          var element = document.createElement('a');
          element.setAttribute('href', 'data:csv;charset=utf-8, ' + encodeURIComponent(csvContent));
          element.setAttribute('download', file);

          document.body.appendChild(element);

          element.click();

          document.body.removeChild(element);
        });
    }


    function formatDate(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatBankAccount(accountNumber) {
      return accountNumber.match(/.{1,4}/g).join(' ');
    }

    function createCSV(data) {

      const headers = [
        "DSR ID",
        "DSR Name",
        "Date",
        "Attendance Status",
        "Tenure"
      ]

      const flattenData = data.map(item => ({
        "DSR ID": item.dsr_id,
        "DSR Name": item.dsr_name,
        "Date": item.date,
        "Attendance Status": item.attendance_status,
        "Tenure": item.tenure,
      }));
      const replacer = (key, value) => (value === null ? "" : value);
      const csvContent = [headers.join(","), ...flattenData.map(row => headers.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(","))].join("\r\n");
      return csvContent;

    }


    document.getElementById("btnExport").addEventListener("click", function () {
      var filename = "dsr_attendance.csv";
      var dsr_id = document.getElementById("dsr_id").value;
      var dsr_name = document.getElementById("dsr_name").value;
      fnExcelReport(filename, dsr_id, dsr_name);
    }, false);

  </script>
  <%- include("../shared/footer"); %>
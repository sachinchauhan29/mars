<%- include("../shared/header"); %>

    <div class="app-page-title">
        <div class="page-title-wrapper">
            <div class="page-title-heading">
                <!-- <div class="page-title-icon">
                    <i class=" fas fa-sort-amount-up icon-gradient bg-mean-fruit">
                    </i>
                </div> -->
                <div>
                    <b> DSR ATTENDANCE</b>
                </div>
            </div>

        </div>
    </div>

    <div class="row">
        <div class="col-md-12 col-lg-12 mx-auto">
            <div class="mb-3 ">
                <div class="card">
                    <div class="card-header-tab card-header-tab-animation card-header">
                        <div class="row">
                            <div class=" col-lg-8 col-md-8  col-12">
                                <h5><b>SELECT REPORT TYPE</b></h5>
                            </div>
                            <div class="col-lg-4 col-lg-4 col-12 text-right">
                                <button id="btnExport" class="btn  btn-outline-alternate custom-button  mr-3"><i
                                        class="metismenu-icon fas fa-arrow-alt-circle-down mr-2"></i>Download</button>
                                <button class="btn-shadow  btn btn-primary custom-btn  btn-lg" data-toggle="collapse"
                                    data-target="#demo"><i class='fas fa-filter mr-2'></i>Filter</button>

                            </div>
                            <div class="mt-3 px-xl-2 col-12">
                                <div class="dis-grid">
                                    <a class="mt-2" href="./kyc">
                                        <img src="./images/off.png" alt="">
                                        DSR Kyc
                                    </a>
                                    <a class="mt-2" href="./edit-kyc-data">
                                        <img src="./images/off.png" alt="">
                                        DSR EDIT KYC
                                    </a>
                                    <a class="mt-2" href="./retailer">
                                        <img src="./images/off.png" alt="">
                                        RETAILER KYC
                                    </a>
                                    <!-- <a class="mt-2" href="./retailer-edit-kyc">
                                        <img src="./images/off.png" alt="">
                                        RETAILER EDIT KYC
                                    </a> -->
                                    <a class="mt-2" href="./distributor">
                                        <img src="./images/off.png" alt="">
                                        DISTRIBUTOR KYC
                                    </a>
                                    <a class="mt-2" href="./authentication">
                                        <img src="./images/on.png" alt="">
                                        DSR ATTENDANCE
                                    </a>
                                    <a class="mt-2" href="./payout">
                                        <img src="./images/off.png" alt="">
                                        DSR PAYOUT
                                    </a>
                                    <a class="mt-2" href="./kyc-history">
                                        <img src="./images/off.png" alt="">
                                        DSR KYC History</a>
                                    <a class="mt-2" href="./retailer-history">
                                        <img src="./images/off.png" alt="">
                                        RETAILER KYC History
                                    </a>
                                    <a class="mt-2" href="./master-data">
                                        <img src="./images/off.png" alt="">
                                        MASTER DATA
                                    </a>
                                    <a class="mt-2" href="./kyc-status">
                                        <img src="./images/off.png" alt="">
                                        KYC STATUS
                                    </a>
                                    <!-- <a class="mt-2" href="./awsm-updation">
                                        <img src="./images/off.png" alt="">
                                        AWSM UPDATION
                                    </a> -->
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="table-responsive">
                        <div class="card-body">


                            <div id="demo" class="collapse">
                                <form action="./authentication">
                                    <div class="row">
                                        <div class="col-2">
                                            <label for="salesman_id" class="mr-sm-2">DSR ID</label>
                                            <input type="text" class="form-control" id="awsm_code" placeholder="dsr_id"
                                                name="salesman_id" value="<%=QueryData.salesman_id %>">
                                        </div>

                                        <div class="col-2">
                                            <label for="salesman_name" class="mr-sm-2">DSR NAME</label>
                                            <input type="text" class="form-control" id="awsm_name"
                                                placeholder="dsr_name" name="salesman_name"
                                                value="<%=QueryData.salesman_name %>">
                                        </div>
                                        <div class="col-2">

                                            <label for="FROM" class="mr-sm-2">FROM</label>

                                            <input type="date" class="form-control" id="fromDate" placeholder="fromDate"
                                                name="fromDate" value="<%=QueryData.fromDate %>">
                                        </div>
                                        <div class="col-2">

                                            <label for="TO" class="mr-sm-2">TO</label>

                                            <input type="date" class="form-control" id="toDate" placeholder="toDate"
                                                name="toDate" value="<%=QueryData.toDate %>">

                                        </div>
                                    </div>

                                    <div class="text-right mb-3">
                                        <!-- <a href="./authentication"
                                            class="btn btn-outline-alternate  custom-button  reset-anchor mr-3 mt-3">Reset</a> -->
                                        <button type="reset"
                                            class="btn  btn-outline-alternate custom-button  reset-anchor mr-3 mt-3">Reset</button>
                                        <button type="submit"
                                            class="btn-shadow  btn btn-primary custom-btn btn-lg  mt-3">Apply</button>

                                    </div>
                                </form>
                            </div>

                            <div class="dataTables_info" id="example_info" role="status" aria-live="polite">
                                Showing <%= Math.min((currentPage - 1) * 10 + 1, totalEntrie) %> to <%=
                                        Math.min(currentPage * 10, totalEntrie) %> of <%= totalEntrie %> entries
                            </div>

                            <div class="table table-striped table-bordered table-responsive dataTable no-footer">

                                <table id="auth" class="table dataTables_wrapper  table-bordered" cellspacing="0"
                                    width="100%">
                                    <thead>
                                        <tr>
                                            <th class="tabel-width">DSR ID</th>
                                            <th class="tabel-width">DSR Name</th>
                                            <th class="tabel-width">DATE Time</th>
                                            <th class="tabel-width">Attendance Status</th>
                                        </tr>
                                        <!-- <tr>
                                            <th class="tabel-width">CREATED ON</th>
                                            <th class="tabel-width">SO EMAIL ID</th>
                                            <th class="tabel-width">SO CODE</th>
                                            <th class="tabel-width">SO NAME</th>
                                            <th class="tabel-width">Distributor ID</th>
                                            <th class="tabel-width">Distributor NAME</th>
                                            <th class="tabel-width">DSR ID</th>
                                            <th class="tabel-width">DSR NAME</th>
                                            <th class="tabel-width">DSR TYPE</th>
                                            <th class="tabel-width">VIKAS ID</th>
                                            <th class="tabel-width">HQ LOCATION</th>
                                            <th class="tabel-width">BENEFICIARY NAME</th>
                                            <th class="tabel-width">STATE</th>
                                            <th class="tabel-width">CITY</th>
                                            <th class="tabel-width">ADDRESS</th>
                                            <th class="tabel-width">BANK A/C NO.</th>
                                            <th class="tabel-width">BANK NAME</th>
                                            <th class="tabel-width">IFSC CODE</th>
                                            <th class="tabel-width">MOBILE NO</th>
                                            <th class="tabel-width">GENDER</th>
                                            <th class="tabel-width">DOB</th>
                                            <th class="tabel-width">CHANNEL TYPE</th>
                                            <th class="tabel-width">BIOMETRIC</th>
                                            <th class="tabel-width">KYC METHOD</th>
                                        </tr> -->
                                    </thead>
                                    <!-- <tbody>
                                        <% authenticationDetails.forEach(function(kyc) { %>
                                            <tr>
                                                <td>
                                                    <%= kyc.created_on.toLocaleDateString('en-IN') %>
                                                </td>
                                                <td>
                                                    <%= kyc.ase_email_id %>
                                                </td>
                                                <td>
                                                    <%= kyc.ase_employee_code %>
                                                </td>
                                                <td>
                                                    <%= kyc.ase_name %>
                                                </td>
                                                <td>
                                                    <%= kyc.aw_code %>
                                                </td>
                                                <td>
                                                    <%= kyc.aw_name %>
                                                </td>
                                                <td>
                                                    <%= kyc.awsm_code %>
                                                </td>
                                                <td>
                                                    <%= kyc.awsm_name %>
                                                </td>
                                                <td>
                                                    <%= kyc.salesman_type %>
                                                </td>
                                                <td></td>
                                                <td>
                                                    <%= (kyc.hq_location)? hq_location: '' %>
                                                </td>
                                                <td>
                                                    <%= kyc.beneficiary_name %>
                                                </td>
                                                <td>
                                                    <%= kyc.awsm_state %>
                                                </td>
                                                <td>
                                                    <%= kyc.awsm_city %>
                                                </td>
                                                <td>
                                                    <%= kyc.address %>
                                                </td>
                                                <td>
                                                    <%= kyc.bank_account_no %>
                                                </td>
                                                <td>
                                                    <%= kyc.bank_name %>
                                                </td>
                                                <td>
                                                    <%= kyc.ifsc_code %>
                                                </td>
                                                <td>
                                                    <%= (kyc.mobile_no)?kyc.mobile_no:'' %>
                                                </td>
                                                <td>
                                                    <%= kyc.gender %>
                                                </td>
                                                <td>
                                                    <%= (kyc.dob)?kyc.dob.toLocaleDateString('en-IN'):'' %>
                                                </td>
                                                <td>
                                                    <%= (kyc.channel)?kyc.channel:'' %>
                                                </td>
                                                <td>
                                                    <%= (kyc.biometric_flag)? true: false %>
                                                </td>
                                                <td>
                                                    <%= (kyc.auth_methed)? kyc.auth_methed: '' %>
                                                </td>
                                            </tr>
                                            <% }); %>
                                    </tbody> -->
                                </table>



                            </div>
                            <div class="dataTables_paginate paging_simple_numbers mb-5" id="example_paginate">
                                <a href="/authentication?page=<%= currentPage - 1 %>"
                                    class="paginate_button previous <%= startPage === 1 ? 'disabled' : '' %>"
                                    aria-controls="example" data-dt-idx="0" tabindex="-1"
                                    id="example_previous">Previous</a>
                                <span>
                                    <% for (let i=startPage; i <=endPage; i++) { %>
                                        <a href="/authentication?page=<%=i%>" class="paginate_button current"
                                            aria-controls="example" data-dt-idx="<%=i %>" tabindex="0">
                                            <%= i %>
                                        </a>
                                        <% } %>
                                </span>
                                <a href="/authentication?page=<%= (parseInt(currentPage) + 1) %>"
                                    class="paginate_button next <%= endPage === totalRows ? 'disabled' : '' %>"
                                    aria-controls="example" id="example_next">Next</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var table = document.querySelector('#example');
            var dataTable = new DataTable(table, {
                dom: '<"dt-buttons"Bf><"clear">lirtp',
                paging: true,
                autoWidth: true,
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: 'Excel',
                        filename: 'DataTableExcel',
                        exportOptions: {
                            columns: ':visible'
                        }
                    }
                ]
            });
        });

    </script>
    <!-- <script>

        function fnExcelReport(file) {

            fetch(`/authentication/export`)
                .then((res) => res.json())
                .then((data) => {

                    data.forEach((item) => {
                        item.dob = formatDate(item.dob);
                        item.created_on = formatDate(item.created_on);
                        item.bank_account_no = formatBankAccount(item.bank_account_no);
                    });

                    const csvContent = createCSV(data);

                    var element = document.createElement('a');
                    element.setAttribute('href', 'data:csv;charset=utf-8, ' + encodeURIComponent(csvContent));
                    element.setAttribute('download', file);

                    document.body.appendChild(element);

                    element.click();

                    document.body.removeChild(element);
                });
        }


        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatBankAccount(accountNumber) {
            return accountNumber.match(/.{1,4}/g).join(' ');
        }

        function createCSV(data) {
            const replacer = (key, value) => value === null ? '' : value;
            const header = Object.keys(data[0])
            const csvContent = [
                header.join(','),
                ...data.map(row => header.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(','))
            ].join('\r\n');
            return csvContent;
        }


        document.getElementById("btnExport")
            .addEventListener("click", function () {
                var filename = "authentication.csv";
                fnExcelReport(filename);
            }, false);

    </script> -->


    <script>
        function fnExcelReport(file, mobile_no, awsm_code, awsm_name, salesman_type, aw_code, aw_name, ase_code, ase_name, fromDate, toDate, awsm_state, awsm_city) {
            fetch(`/authentication/export?mobile_no=${mobile_no}&awsm_code=${awsm_code}&awsm_name=${awsm_name}&salesman_type=${salesman_type}&aw_code=${aw_code}&aw_name=${aw_name}&ase_code=${ase_code}&ase_name=${ase_name}&fromDate=${fromDate}&toDate=${toDate}&awsm_state=${awsm_state}&awsm_city=${awsm_city}`)
                .then((res) => res.json())
                .then((data) => {
                    data.forEach((item) => {
                        item.dob = formatDate(item.dob);
                        item.created_on = formatDate(item.created_on);
                        item.bank_account_no = formatBankAccount(item.bank_account_no);
                    });

                    const csvContent = createCSV(data);

                    var element = document.createElement('a');
                    element.setAttribute('href', 'data:csv;charset=utf-8, ' + encodeURIComponent(csvContent));
                    element.setAttribute('download', file);

                    document.body.appendChild(element);

                    element.click();

                    document.body.removeChild(element);
                });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatBankAccount(accountNumber) {
            return accountNumber.match(/.{1,4}/g).join(' ');
        }

        function createCSV(data) {
            const headers = [
                "CREATED ON",
                "ASE EMAIL ID",
                "ASE CODE",
                "ASE NAME",
                "AW ID",
                "AW NAME",
                "SALESMAN ID",
                "SALESMAN NAME",
                "SALESMAN TYPE",
                "VIKAS ID",
                "HQ LOCATION",
                "BENEFICIARY NAME",
                "STATE",
                "CITY",
                "ADDRESS",
                "BANK A/C NO.",
                "BANK NAME",
                "IFSC CODE",
                "MOBILE NO",
                "GENDER",
                "DOB",
                "CHANNEL TYPE",
                "AUTHENTICATION",
                "KYC METHOD"
            ];

            const flattenData = data.map(item => ({
                "CREATED ON": item.formatted_created_on,
                "ASE EMAIL ID": item.ase_email,
                "ASE CODE": item.ase_employee_code,
                "ASE NAME": item.ase_name,
                "AW ID": item.aw_code,
                "AW NAME": item.aw_name,
                "SALESMAN ID": item.awsm_code,
                "SALESMAN NAME": item.awsm_name,
                "SALESMAN TYPE": item.salesman_type,
                "BENEFICIARY NAME": item.beneficiary_name,
                "STATE": item.awsm_state,
                "CITY": item.awsm_city,
                "ADDRESS": item.address,
                "BANK A/C NO.": item.bank_account_no,
                "BANK NAME": item.bank_name,
                "IFSC CODE": item.ifsc_code,
                "MOBILE NO": item.mobile_no,
                "GENDER": item.gender,
                "DOB": item.dob,
                "CHANNEL TYPE": item.channel,
                "AUTHENTICATION": item.biometric_flag == 1 ? true : false,
                "KYC METHOD": item.auth_methed
            }));

            const replacer = (key, value) => (value === null ? "" : value);
            const csvContent = [headers.join(","), ...flattenData.map(row => headers.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(","))].join("\r\n");
            return csvContent;
        }

        document.getElementById("btnExport")
            .addEventListener("click", function () {
                var filename = "authentication.csv";
                var mobile_no = document.getElementById("mobile_no").value;
                var awsm_code = document.getElementById("awsm_code").value;
                var awsm_name = document.getElementById("awsm_name").value;
                var salesman_type = document.getElementById("salesman_type").value;
                var aw_code = document.getElementById("aw_code").value;
                var aw_name = document.getElementById("aw_name").value;
                var ase_code = document.getElementById("ase_code").value;
                var ase_name = document.getElementById("ase_name").value;
                var fromDate = document.getElementById("fromDate").value;
                var toDate = document.getElementById("toDate").value;
                var awsm_state = document.getElementById("awsm_state").value;
                var awsm_city = document.getElementById("awsm_city").value;
                fnExcelReport(filename, mobile_no, awsm_code, awsm_name, salesman_type, aw_code, aw_name, ase_code, ase_name, fromDate, toDate, awsm_state, awsm_city);
            }, false);

    </script>
    <%- include("../shared/footer"); %>